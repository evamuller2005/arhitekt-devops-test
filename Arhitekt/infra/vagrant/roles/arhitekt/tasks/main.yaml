- name: update packages
  apt:
    update_cache: yes

- name: instaliraj docker
  apt:
    name: docker.io
    state: present

- name: enable docker 
  systemd:
    name: docker
    enabled: yes
    state: started

- name: run ms sql v dockerju
  command: >
    docker run -e "ACCEPT_EULA=Y"
    -e "MSSQL_SA_PASSWORD=Arhitekt2025"
    -e "MSSQL_PID=Developer"
    -p 1433:1433
    --name arhitekt-sql
    -d mcr.microsoft.com/mssql/server:2025-latest
  args:
    creates: /var/lib/docker/containers/arhitekt-sql

- name: wait for ms sql server to start
  pause:
    seconds: 30

- name: run redis
  command: docker run -p 6379:6379 --name arhitekt-redis -d redis:7
  args:
    creates: /var/lib/docker/containers/arhitekt-redis    

- name: install .net SDK
  apt:
    name: dotnet-sdk-8.0
    state: present

- name: clone git repo
  git:
    repo: "https://github.com/evamuller2005/arhitekt-devops-test.git"
    dest: "/home/vagrant/arhitekt-devops"

- name: publish dotnet app
  command: dotnet publish -c Release -o /home/vagrant/arhitekt-published
  args:
    chdir: /home/vagrant/arhitekt-devops

- name: install nginx
  apt:
    name: nginx
    state: present

- name: create ssl directory
  file:
    path: /etc/nginx/ssl
    state: directory
    mode: '0755'

- name: create self-signed certificate
  command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout /etc/nginx/ssl/arhitekt.key
    -out /etc/nginx/ssl/arhitekt.crt
    -subj "/C=SI/ST=LJ/L=LJ/O=Arhitekt/OU=DevOps/CN=arhitekt.local"
  args:
    creates: /etc/nginx/ssl/arhitekt.crt

- name: configure nginx reverse proxy
  copy:
    dest: /etc/nginx/sites-available/arhitekt
    content: |
      server {
        listen 80;

        location / {
            proxy_pass http://127.0.0.1:5059;
        }
      }

      server {
          listen 443 ssl;

          ssl_certificate     /etc/nginx/ssl/arhitekt.crt;
          ssl_certificate_key /etc/nginx/ssl/arhitekt.key;

          location / {
              proxy_pass http://localhost:5059;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }

- name: enable nginx config
  command: ln -s /etc/nginx/sites-available/arhitekt /etc/nginx/sites-enabled/arhitekt
  args:
    creates: /etc/nginx/sites-enabled/arhitekt

- name: remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent    

- name: restart nginx
  systemd:
    name: nginx
    state: restarted

- name: create systemd service
  copy:
    dest: /etc/systemd/system/arhitekt.service
    content: |
      [Unit]
      Description=Arhitekt ASP.NET Core Application
      After=network.target docker.service docker.socket

      [Service]
      WorkingDirectory=/home/vagrant/arhitekt-published
      ExecStart=/usr/bin/dotnet /home/vagrant/arhitekt-published/Arhitekt.dll
      Restart=always
      RestartSec=10
      User=vagrant
      Environment=ASPNETCORE_URLS=http://0.0.0.0:5059
      Environment=ASPNETCORE_ENVIRONMENT=Production
      Environment=ConnectionStrings__DefaultConnection=Server=localhost,1433;Database=Arhitekt;User Id=sa;Password=Arhitekt2025;TrustServerCertificate=True;
      Environment=Redis__Host=localhost:6379

      [Install]
      WantedBy=multi-user.target

- name: reload systemd
  command: systemctl daemon-reload

- name: enable arhitekt service
  systemd:
    name: arhitekt.service
    enabled: yes
    state: started 